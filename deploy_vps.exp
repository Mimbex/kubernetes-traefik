#!/usr/bin/expect -f

# Configuration
set ip "161.132.45.204"
set user "root"
set password "LQA4yEht9FaG"
set repo "https://github.com/Mimbex/kubernetes-traefik.git"
set dir "/opt/kubernetes-traefik"

# Timeout
set timeout 300

# Connect silently
spawn ssh -o StrictHostKeyChecking=no $user@$ip

expect {
    "password:" {
        send "$password\r"
        exp_continue
    }
    "# " {
        # Logged in shell
        send_user "\nâœ… Connected to $ip\n"
    }
    timeout {
        send_user "\nâŒ Connection timed out\n"
        exit 1
    }
}

# 1. Update system and install git
send "apt-get update && apt-get install -y git\r"
expect "# "

# 2. Setup directory and clone
send "if [ -d \"$dir\" ]; then rm -rf $dir; fi\r"
expect "# "

send "cd /opt && git clone $repo\r"
expect {
    "Login" {
        send_user "\nâŒ Repo seems private or needs credentials. Please check URL.\n"
        exit 1
    }
    "# " {
        send_user "\nâœ… Repository cloned\n"
    }
}

# 3. Setup environment
send "cd $dir\r"
expect "# "

send "cp .env.example .env\r"
expect "# "

send "chmod +x *.sh scripts/*.sh odooctl\r"
expect "# "

# 4. Final message
send "echo '\n======================================================='\r"
send "echo 'ğŸ‰ Despliegue del cÃ³digo completado en $dir'\r"
send "echo 'ğŸ“ Siguientes pasos:'\r"
send "echo '  1. cd $dir'\r"
send "echo '  2. nano .env  (Configura tu dominio y versiones)'\r"
send "echo '  3. ./install-everything.sh'\r"
send "echo '======================================================='\n\r"
expect "# "

send "exit\r"
expect eof
